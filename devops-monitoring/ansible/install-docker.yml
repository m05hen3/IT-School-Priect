- name: Install Docker and Docker Compose
  hosts: remote
  vars_files:
    - vars.yml
  become: true

  tasks:
    - name: Detect distro
      debug:
        msg: "Install docker on {{ ansible_distribution }} {{ ansible_distribution_version }}"

    - name: Install Docker on Debian/Ubuntu
      when: ansible_distribution in ["Debian", "Ubuntu"]
      block:
        - name: Update apt package
          apt:
            update_cache: yes
        
        - name: Install curl
          apt:
            name: curl
            state: present

        - name: Add Docker's official GPG key
          apt_key:
            url: https://download.docker.com/linux/{{ ansible_distribution | lower }}/gpg
            state: present
        
        - name: Add Docker repository
          apt_repository:
            repo: "deb [arch=amd64] https://download.docker.com/linux/{{ ansible_distribution | lower }} {{ ansible_distribution_release }} stable" 
            state: present

        - name: Install Docker Engine and Compose plugin
          apt:
            update_cache: yes
            name:
              - docker-ce
              - docker-ce-cli
              - containerd.io
              - docker-compose-plugin
            state: present

        - name: Ensure Docker service is running
          service:
            name: docker
            state: started
            enabled: true

        - name: Fail if distro not supported
          fail:
            msg: "Distributia {{ ansible_distribution }} nu este suportata. Doar Debian sau Ubuntu sunt suportate"
          when: ansible_distribution not in ["Debian", "Ubuntu"]
    